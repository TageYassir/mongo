{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/Saas_MongoDB/mongo/app/uis/page.js"],"sourcesContent":["'use client'\r\n\r\nimport React, { useEffect, useState } from 'react'\r\nimport { Box, Button, TextField, Typography, Alert, CircularProgress, IconButton, InputAdornment } from '@mui/material'\r\nimport Visibility from '@mui/icons-material/Visibility'\r\nimport VisibilityOff from '@mui/icons-material/VisibilityOff'\r\n\r\n/**\r\n * /uis page - Login / welcome page\r\n *\r\n * Behavior:\r\n * - Installs a popstate handler so Back navigation always redirects to /uis (endless loop protection).\r\n * - Presents a login form (email + password) that calls POST /api/users?operation=login.\r\n * - On successful login:\r\n *   - Saves the user response to localStorage as { id, ... } (key: 'user')\r\n *   - Replaces the current location with /uis/user-space (window.location.replace) to prevent Back to login.\r\n * - If login fails shows the error message.\r\n *\r\n * Note:\r\n * - For the server-side isOnline flag to be set on login you need an API endpoint that updates the user (e.g. POST /api/users?operation=set-online or a dedicated route).\r\n *   The current server implementation supports logout (operation=logout) but does not automatically flip isOnline=true on login.\r\n *   If you want, I can add a server-side handler to set isOnline=true after successful login.\r\n */\r\n\r\nexport default function UisLoginPage() {\r\n  const [email, setEmail] = useState('')\r\n  const [password, setPassword] = useState('')\r\n  const [loading, setLoading] = useState(false)\r\n  const [error, setError] = useState(null)\r\n  const [info, setInfo] = useState(null)\r\n\r\n  // new: password visibility state + handlers\r\n  const [showPassword, setShowPassword] = useState(false)\r\n  const handleToggleShowPassword = () => setShowPassword((s) => !s)\r\n  const handleMouseDownPassword = (event) => {\r\n    // prevent focus loss on mouse down\r\n    event.preventDefault()\r\n  }\r\n\r\n  // Helper to inform server the user is online. Prefer fetch (so server sees Content-Type),\r\n  // fall back to sendBeacon only if fetch fails or times out.\r\n  async function markUserOnline(userId) {\r\n    if (!userId) return false\r\n    const url = '/api/users?operation=set-online'\r\n    const body = JSON.stringify({ id: userId, isOnline: true })\r\n\r\n    // Try fetch first with a short timeout\r\n    const controller = typeof AbortController !== 'undefined' ? new AbortController() : null\r\n    const signal = controller ? controller.signal : undefined\r\n    const fetchPromise = (async () => {\r\n      try {\r\n        const res = await fetch(url, {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body,\r\n          signal,\r\n        })\r\n        return res.ok\r\n      } catch (e) {\r\n        return false\r\n      }\r\n    })()\r\n\r\n    // If AbortController exists, set a short fetch timeout (e.g. 2s)\r\n    let fetchResult = false\r\n    if (controller) {\r\n      const timeout = setTimeout(() => controller.abort(), 2000)\r\n      try {\r\n        fetchResult = await fetchPromise\r\n      } catch (e) {\r\n        fetchResult = false\r\n      } finally {\r\n        clearTimeout(timeout)\r\n      }\r\n    } else {\r\n      fetchResult = await fetchPromise\r\n    }\r\n\r\n    if (fetchResult) return true\r\n\r\n    // If fetch failed or was aborted, fall back to sendBeacon (best-effort)\r\n    try {\r\n      if (typeof navigator !== 'undefined' && navigator.sendBeacon) {\r\n        const blob = new Blob([body], { type: 'application/json' })\r\n        return navigator.sendBeacon(url, blob)\r\n      }\r\n    } catch (e) {\r\n      // ignore\r\n    }\r\n\r\n    return false\r\n  }\r\n\r\n  // If a user is already stored locally, best-effort mark them online when this page mounts.\r\n  useEffect(() => {\r\n    try {\r\n      const raw = localStorage.getItem('user')\r\n      if (raw) {\r\n        const stored = JSON.parse(raw)\r\n        const uid = stored?.id || stored?._id || stored?.userId\r\n        if (uid && !stored.isOnline) {\r\n          // update local copy immediately\r\n          stored.isOnline = true\r\n          localStorage.setItem('user', JSON.stringify(stored))\r\n          // fire-and-forget (no await); use sendBeacon or short fetch\r\n          markUserOnline(uid)\r\n        }\r\n      }\r\n    } catch (e) {\r\n      // ignore storage/parsing errors\r\n    }\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    // Normalize the current history entry to /uis\r\n    try {\r\n      if (typeof window !== 'undefined' && window.history && window.location) {\r\n        window.history.replaceState(null, '', '/uis')\r\n      }\r\n    } catch (e) {\r\n      // ignore\r\n    }\r\n\r\n    // When the user tries to go back (popstate), force a replace to /uis\r\n    function onPopState() {\r\n      if (typeof window !== 'undefined') {\r\n        // Replace so Back navigation remains stuck on /uis\r\n        window.location.replace('/uis')\r\n      }\r\n    }\r\n\r\n    window.addEventListener('popstate', onPopState)\r\n    return () => window.removeEventListener('popstate', onPopState)\r\n  }, [])\r\n\r\n  async function handleSubmit(e) {\r\n    e.preventDefault()\r\n    setError(null)\r\n    setInfo(null)\r\n\r\n    if (!email || !password) {\r\n      setError('Please enter both email and password.')\r\n      return\r\n    }\r\n\r\n    setLoading(true)\r\n    try {\r\n      // Include isOnline:true in login payload so server-side handlers can set it immediately\r\n      const res = await fetch('/api/users?operation=login', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ email, password, isOnline: true }),\r\n      })\r\n\r\n      const payload = await res.json().catch(() => ({}))\r\n\r\n      if (!res.ok) {\r\n        const msg = payload?.error || `Login failed (${res.status})`\r\n        setError(msg)\r\n        setLoading(false)\r\n        return\r\n      }\r\n\r\n      const user = payload?.user || null\r\n      if (!user) {\r\n        setError('Invalid server response: missing user')\r\n        setLoading(false)\r\n        return\r\n      }\r\n\r\n      // Save user to localStorage (same fallback chat uses) and set isOnline locally\r\n      try {\r\n        const userId = user._id || user.id || user?.id\r\n        const stored = { id: userId, ...user, isOnline: true }\r\n        localStorage.setItem('user', JSON.stringify(stored))\r\n      } catch (err) {\r\n        // ignore storage errors\r\n      }\r\n\r\n      // Best-effort: inform server to mark user as online (fire-and-forget).\r\n      try {\r\n        const userId = user._id || user.id || user?.id\r\n        // don't await — allow immediate redirect\r\n        markUserOnline(userId)\r\n      } catch (e) {\r\n        // ignore\r\n      }\r\n\r\n      // Optionally inform the user\r\n      setInfo('Login successful — redirecting...')\r\n      // Replace the current page with the user-space to avoid Back to login\r\n      if (typeof window !== 'undefined') {\r\n        // Use replace so Login page is removed from history stack\r\n        window.location.replace('/uis/user-space')\r\n      }\r\n    } catch (err) {\r\n      console.error('Login error', err)\r\n      setError('Network or server error during login.')\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <Box sx={{ maxWidth: 480, margin: '48px auto', px: 2 }}>\r\n      <Box sx={{ textAlign: 'center', mb: 3 }}>\r\n        <Typography variant=\"h4\" component=\"h1\">Welcome</Typography>\r\n        <Typography variant=\"body1\" color=\"text.secondary\">Please sign in to continue</Typography>\r\n      </Box>\r\n\r\n      {error && <Alert severity=\"error\" sx={{ mb: 2 }}>{error}</Alert>}\r\n      {info && <Alert severity=\"success\" sx={{ mb: 2 }}>{info}</Alert>}\r\n\r\n      <Box component=\"form\" onSubmit={handleSubmit} sx={{ display: 'grid', gap: 2 }}>\r\n        <TextField\r\n          label=\"Email\"\r\n          type=\"email\"\r\n          value={email}\r\n          onChange={(e) => setEmail(e.target.value)}\r\n          required\r\n          fullWidth\r\n        />\r\n\r\n        {/* updated password field to include visibility toggle */}\r\n        <TextField\r\n          label=\"Password\"\r\n          type={showPassword ? 'text' : 'password'}\r\n          value={password}\r\n          onChange={(e) => setPassword(e.target.value)}\r\n          required\r\n          fullWidth\r\n          InputProps={{\r\n            endAdornment: (\r\n              <InputAdornment position=\"end\">\r\n                <IconButton\r\n                  aria-label={showPassword ? 'Hide password' : 'Show password'}\r\n                  onClick={handleToggleShowPassword}\r\n                  onMouseDown={handleMouseDownPassword}\r\n                  edge=\"end\"\r\n                >\r\n                  {showPassword ? <VisibilityOff /> : <Visibility />}\r\n                </IconButton>\r\n              </InputAdornment>\r\n            ),\r\n          }}\r\n        />\r\n\r\n        <Button type=\"submit\" variant=\"contained\" color=\"primary\" disabled={loading}>\r\n          {loading ? <CircularProgress size={20} /> : 'Sign In'}\r\n        </Button>\r\n\r\n        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n          <Button\r\n            variant=\"text\"\r\n            onClick={() => {\r\n              // navigate to a registration page if exists — replace with your actual registration route\r\n              window.location.href = '/uis/register-screen'\r\n            }}\r\n          >\r\n            Create account\r\n          </Button>\r\n\r\n          <Button\r\n            variant=\"text\"\r\n            onClick={() => {\r\n              // help / forgot password route if you have one\r\n              window.location.href = '/uis/recovery-screen'\r\n            }}\r\n          >\r\n            Forgot password?\r\n          </Button>\r\n        </Box>\r\n      </Box>\r\n\r\n      <Box sx={{ mt: 4, textAlign: 'center', color: 'text.secondary' }}>\r\n        <Typography variant=\"caption\">After logging out you will be redirected to this page and cannot go back.</Typography>\r\n      </Box>\r\n    </Box>\r\n  )\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}