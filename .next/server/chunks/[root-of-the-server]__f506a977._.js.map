{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 49, "column": 0}, "map": {"version":3,"sources":["file:///D:/Saas_MongoDB/mongo/app/api/crypto/transfer/route.js"],"sourcesContent":["import mongoose from 'mongoose';\r\nimport Wallet from '@/models/Wallet'; // adjust path to your Wallet model\r\n\r\nexport async function POST(req) {\r\n  const body = await req.json();\r\n  const { fromWalletId, toWalletId, amount } = body;\r\n  const amt = Number(amount);\r\n  if (!fromWalletId || !toWalletId || !amt || amt <= 0) {\r\n    return new Response(JSON.stringify({ error: 'Invalid input' }), { status: 400 });\r\n  }\r\n\r\n  // Ensure mongoose is connected before starting a session\r\n  if (!mongoose.connection.readyState) {\r\n    // adjust your db connect flow if needed\r\n    // e.g. await dbConnect();\r\n  }\r\n\r\n  let session = null;\r\n\r\n  try {\r\n    session = await mongoose.startSession();\r\n    // Try to start a transaction â€” this will fail on standalone mongod\r\n    try {\r\n      session.startTransaction();\r\n    } catch (startTxnErr) {\r\n      // If transactions are not supported (code 20) we'll fall back below\r\n      if (startTxnErr && startTxnErr.code === 20) {\r\n        throw startTxnErr; // jump to outer catch which will fallback\r\n      }\r\n      throw startTxnErr;\r\n    }\r\n\r\n    // debit sender if they have enough balance\r\n    const sender = await Wallet.findOneAndUpdate(\r\n      { walletId: fromWalletId, balance: { $gte: amt } },\r\n      { $inc: { balance: -amt } },\r\n      { new: true, session }\r\n    );\r\n    if (!sender) {\r\n      await session.abortTransaction();\r\n      session.endSession();\r\n      return new Response(JSON.stringify({ error: 'Insufficient funds or sender not found' }), { status: 400 });\r\n    }\r\n\r\n    // credit receiver\r\n    const receiver = await Wallet.findOneAndUpdate(\r\n      { walletId: toWalletId },\r\n      { $inc: { balance: amt } },\r\n      { new: true, session }\r\n    );\r\n    if (!receiver) {\r\n      // receiver missing: abort\r\n      await session.abortTransaction();\r\n      session.endSession();\r\n      return new Response(JSON.stringify({ error: 'Receiver not found' }), { status: 404 });\r\n    }\r\n\r\n    await session.commitTransaction();\r\n    session.endSession();\r\n\r\n    return new Response(JSON.stringify({ success: true, sender, receiver }), { status: 200 });\r\n  } catch (err) {\r\n    // If error indicates transactions are not supported, fallback to non-transactional transfer\r\n    const fallbackCondition = err && (err.code === 20 || (err.message && err.message.includes('Transaction numbers')));\r\n    if (fallbackCondition) {\r\n      // Best-effort non-transactional transfer:\r\n      try {\r\n        // 1) debit sender atomically if enough balance\r\n        const sender = await Wallet.findOneAndUpdate(\r\n          { walletId: fromWalletId, balance: { $gte: amt } },\r\n          { $inc: { balance: -amt } },\r\n          { new: true }\r\n        );\r\n        if (!sender) {\r\n          return new Response(JSON.stringify({ error: 'Insufficient funds or sender not found (no-transaction fallback)' }), { status: 400 });\r\n        }\r\n\r\n        // 2) credit receiver\r\n        const receiver = await Wallet.findOneAndUpdate(\r\n          { walletId: toWalletId },\r\n          { $inc: { balance: amt } },\r\n          { new: true }\r\n        );\r\n        if (!receiver) {\r\n          // try to compensate: credit back the sender\r\n          await Wallet.findOneAndUpdate({ walletId: fromWalletId }, { $inc: { balance: amt } });\r\n          return new Response(JSON.stringify({ error: 'Receiver not found. Transfer aborted and sender compensated (best-effort)' }), { status: 404 });\r\n        }\r\n\r\n        return new Response(JSON.stringify({ success: true, sender, receiver, warning: 'Performed without transaction (standalone mongod)' }), { status: 200 });\r\n      } catch (fallbackErr) {\r\n        return new Response(JSON.stringify({ error: 'Fallback transfer failed', detail: String(fallbackErr) }), { status: 500 });\r\n      }\r\n    }\r\n\r\n    // Other errors: abort transaction if applicable\r\n    try {\r\n      if (session) {\r\n        await session.abortTransaction();\r\n        session.endSession();\r\n      }\r\n    } catch (e) { /* ignore */ }\r\n\r\n    // log and return error\r\n    console.error('transfer error (txn)', err);\r\n    return new Response(JSON.stringify({ error: 'Transfer failed', detail: String(err) }), { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}