{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 79, "column": 0}, "map": {"version":3,"sources":["file:///D:/Saas_MongoDB/mongo/app/api/messages/upload/route.js"],"sourcesContent":["'use server'\r\n\r\n/**\r\n * Simple upload handler for /api/messages/upload\r\n *\r\n * - Parses multipart/form-data with formidable\r\n * - Saves uploaded files into /public/uploads\r\n * - Returns JSON: { file: { url, filename, size, mimeType } }\r\n *\r\n * Note: requires \"formidable\" package. Install it:\r\n *   npm install formidable\r\n *\r\n * If you deploy to serverless or want remote storage (S3), replace this implementation\r\n * to stream directly to the external storage service.\r\n */\r\n\r\nimport { NextResponse } from \"next/server\"\r\nimport fs from \"fs\"\r\nimport path from \"path\"\r\nimport { IncomingForm } from \"formidable\"\r\n\r\nconst CORS_HEADERS = {\r\n  \"Access-Control-Allow-Origin\": \"*\",\r\n  \"Access-Control-Allow-Methods\": \"POST, OPTIONS\",\r\n  \"Access-Control-Allow-Headers\": \"Content-Type, Authorization\",\r\n}\r\n\r\nexport function OPTIONS() {\r\n  return new NextResponse(null, { status: 204, headers: CORS_HEADERS })\r\n}\r\n\r\nfunction ensureUploadsDir() {\r\n  const uploadsDir = path.join(process.cwd(), \"public\", \"uploads\")\r\n  if (!fs.existsSync(uploadsDir)) {\r\n    fs.mkdirSync(uploadsDir, { recursive: true })\r\n  }\r\n  return uploadsDir\r\n}\r\n\r\nexport async function POST(req) {\r\n  try {\r\n    // formidable parsing in Next.js route\r\n    const form = new IncomingForm({ multiples: false }) // single file expected, adjust as needed\r\n    form.uploadDir = ensureUploadsDir()\r\n    form.keepExtensions = true\r\n\r\n    // parse returns a promise wrapper\r\n    const parsed = await new Promise((resolve, reject) => {\r\n      form.parse(req, (err, fields, files) => {\r\n        if (err) return reject(err)\r\n        resolve({ fields, files })\r\n      })\r\n    })\r\n\r\n    // get first file (field name 'file' expected)\r\n    const fileField = parsed.files && (parsed.files.file || parsed.files[Object.keys(parsed.files)[0]])\r\n    if (!fileField) {\r\n      return NextResponse.json({ error: \"No file uploaded\" }, { status: 400, headers: CORS_HEADERS })\r\n    }\r\n\r\n    const filePath = fileField.path || fileField.filepath || fileField.file\r\n    const origName = fileField.name || fileField.originalFilename || path.basename(filePath)\r\n    const size = fileField.size || (fileField.size === 0 ? 0 : null)\r\n    const mimeType = fileField.type || fileField.mimetype || null\r\n\r\n    // create a safe filename (timestamp + original name)\r\n    const ext = path.extname(origName)\r\n    const base = path.basename(origName, ext).replace(/[^a-z0-9_\\-]/gi, '_')\r\n    const filename = `${Date.now()}-${base}${ext || ''}`\r\n    const uploadsDir = ensureUploadsDir()\r\n    const destPath = path.join(uploadsDir, filename)\r\n\r\n    // move file from tmp to uploads (formidable may already write there; but ensure)\r\n    await fs.promises.rename(filePath, destPath).catch(async (err) => {\r\n      // if rename fails (e.g. same file), try copy\r\n      await fs.promises.copyFile(filePath, destPath)\r\n      try { await fs.promises.unlink(filePath) } catch (e) {}\r\n    })\r\n\r\n    const url = `/uploads/${filename}`\r\n    const fileMeta = { url, filename, size: Number(size || 0), mimeType }\r\n\r\n    return NextResponse.json({ file: fileMeta }, { status: 200, headers: CORS_HEADERS })\r\n  } catch (err) {\r\n    console.error(\"POST /api/messages/upload error:\", err)\r\n    return NextResponse.json({ error: err.message || String(err) }, { status: 500, headers: CORS_HEADERS })\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;;AAEA;;;;;;;;;;;;CAYC,GAED;AACA;AACA;;;;;;;;;;;;;AAGA,MAAM,eAAe;IACnB,+BAA+B;IAC/B,gCAAgC;IAChC,gCAAgC;AAClC;AAEO,SAAS;IACd,OAAO,IAAI,gJAAY,CAAC,MAAM;QAAE,QAAQ;QAAK,SAAS;IAAa;AACrE;AAEA,SAAS;IACP,MAAM,aAAa,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,UAAU;IACtD,IAAI,CAAC,wGAAE,CAAC,UAAU,CAAC,aAAa;QAC9B,wGAAE,CAAC,SAAS,CAAC,YAAY;YAAE,WAAW;QAAK;IAC7C;IACA,OAAO;AACT;AAEO,eAAe,KAAK,GAAG;IAC5B,IAAI;QACF,sCAAsC;QACtC,MAAM,OAAO,IAAI,aAAa;YAAE,WAAW;QAAM,GAAG,yCAAyC;;QAC7F,KAAK,SAAS,GAAG;QACjB,KAAK,cAAc,GAAG;QAEtB,kCAAkC;QAClC,MAAM,SAAS,MAAM,IAAI,QAAQ,CAAC,SAAS;YACzC,KAAK,KAAK,CAAC,KAAK,CAAC,KAAK,QAAQ;gBAC5B,IAAI,KAAK,OAAO,OAAO;gBACvB,QAAQ;oBAAE;oBAAQ;gBAAM;YAC1B;QACF;QAEA,8CAA8C;QAC9C,MAAM,YAAY,OAAO,KAAK,IAAI,CAAC,OAAO,KAAK,CAAC,IAAI,IAAI,OAAO,KAAK,CAAC,OAAO,IAAI,CAAC,OAAO,KAAK,CAAC,CAAC,EAAE,CAAC;QAClG,IAAI,CAAC,WAAW;YACd,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;gBAAK,SAAS;YAAa;QAC/F;QAEA,MAAM,WAAW,UAAU,IAAI,IAAI,UAAU,QAAQ,IAAI,UAAU,IAAI;QACvE,MAAM,WAAW,UAAU,IAAI,IAAI,UAAU,gBAAgB,IAAI,4GAAI,CAAC,QAAQ,CAAC;QAC/E,MAAM,OAAO,UAAU,IAAI,IAAI,CAAC,UAAU,IAAI,KAAK,IAAI,IAAI,IAAI;QAC/D,MAAM,WAAW,UAAU,IAAI,IAAI,UAAU,QAAQ,IAAI;QAEzD,qDAAqD;QACrD,MAAM,MAAM,4GAAI,CAAC,OAAO,CAAC;QACzB,MAAM,OAAO,4GAAI,CAAC,QAAQ,CAAC,UAAU,KAAK,OAAO,CAAC,kBAAkB;QACpE,MAAM,WAAW,GAAG,KAAK,GAAG,GAAG,CAAC,EAAE,OAAO,OAAO,IAAI;QACpD,MAAM,aAAa;QACnB,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,YAAY;QAEvC,iFAAiF;QACjF,MAAM,wGAAE,CAAC,QAAQ,CAAC,MAAM,CAAC,UAAU,UAAU,KAAK,CAAC,OAAO;YACxD,6CAA6C;YAC7C,MAAM,wGAAE,CAAC,QAAQ,CAAC,QAAQ,CAAC,UAAU;YACrC,IAAI;gBAAE,MAAM,wGAAE,CAAC,QAAQ,CAAC,MAAM,CAAC;YAAU,EAAE,OAAO,GAAG,CAAC;QACxD;QAEA,MAAM,MAAM,CAAC,SAAS,EAAE,UAAU;QAClC,MAAM,WAAW;YAAE;YAAK;YAAU,MAAM,OAAO,QAAQ;YAAI;QAAS;QAEpE,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,MAAM;QAAS,GAAG;YAAE,QAAQ;YAAK,SAAS;QAAa;IACpF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,oCAAoC;QAClD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,IAAI,OAAO,IAAI,OAAO;QAAK,GAAG;YAAE,QAAQ;YAAK,SAAS;QAAa;IACvG;AACF;;;IA5DgB;IAYM;;AAZN,iPAAA;AAYM,iPAAA","debugId":null}}]
}