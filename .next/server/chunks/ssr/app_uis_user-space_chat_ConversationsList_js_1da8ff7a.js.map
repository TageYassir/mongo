{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/Saas_MongoDB/mongo/app/uis/user-space/chat/ConversationsList.js.js"],"sourcesContent":["'use client'\r\n\r\nimport React, { useEffect, useState } from 'react'\r\nimport { useRouter } from 'next/navigation'\r\nimport { Box, CircularProgress, List, ListItem, ListItemText, Typography, Avatar, ListItemAvatar, Divider, Paper, TextField, InputAdornment, IconButton } from '@mui/material'\r\nimport SearchIcon from '@mui/icons-material/Search'\r\nimport ClearIcon from '@mui/icons-material/Clear'\r\n\r\n/**\r\n * ConversationsList\r\n *\r\n * - Loads current user id (server endpoint fallback -> localStorage)\r\n * - Loads messages for user and groups them by peer id keeping last message\r\n * - Resolves peer user records by id (GET /api/users/:id preferred, fallback to /api/users?operation=get-user&id=...)\r\n * - Shows peer pseudo (or firstName / email) in the list instead of raw ids\r\n */\r\n\r\nexport default function ConversationsList() {\r\n  const router = useRouter()\r\n  const [query, setQuery] = useState(\"\")\r\n  const [currentUserId, setCurrentUserId] = useState(null)\r\n  const [loading, setLoading] = useState(true)\r\n  const [conversations, setConversations] = useState([]) // { peerId, lastText, lastAt, lastSentAtRaw, peer }\r\n  const [error, setError] = useState(null)\r\n\r\n  useEffect(() => {\r\n    async function loadCurrentUser() {\r\n      try {\r\n        const res = await fetch(\"/api/users?operation=get-current\")\r\n        if (res.ok) {\r\n          const payload = await res.json()\r\n          const uid = payload?.user?._id || payload?.user?.id || payload?.current?.id || payload?.id || null\r\n          if (uid) { setCurrentUserId(uid); return }\r\n        }\r\n      } catch (e) { /* ignore */ }\r\n\r\n      // fallback localStorage\r\n      try {\r\n        const raw = typeof window !== \"undefined\" ? localStorage.getItem(\"user\") : null\r\n        if (raw) {\r\n          const parsed = JSON.parse(raw)\r\n          if (parsed?.id) { setCurrentUserId(parsed.id); return }\r\n        }\r\n      } catch (e) { /* ignore */ }\r\n\r\n      setCurrentUserId(null)\r\n    }\r\n\r\n    loadCurrentUser()\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    async function loadConversations() {\r\n      if (!currentUserId) {\r\n        setLoading(false)\r\n        return\r\n      }\r\n\r\n      setLoading(true)\r\n      setError(null)\r\n      try {\r\n        const url = `/api/messages?operation=get-by-user&userId=${encodeURIComponent(currentUserId)}`\r\n        const res = await fetch(url)\r\n        if (!res.ok) {\r\n          const payload = await res.json().catch(() => null)\r\n          setError(payload?.error || `Server returned ${res.status}`)\r\n          setConversations([])\r\n          setLoading(false)\r\n          return\r\n        }\r\n\r\n        const payload = await res.json()\r\n        const msgs = Array.isArray(payload?.messages) ? payload.messages : []\r\n\r\n        // Group by peer id and keep the latest message per conversation\r\n        const map = new Map()\r\n        msgs.forEach((m) => {\r\n          const otherId = (String(m.senderId) === String(currentUserId)) ? String(m.receiverId) : String(m.senderId)\r\n          if (!otherId) return\r\n          const existing = map.get(otherId)\r\n          const msgTime = m.sentAt ? new Date(m.sentAt).getTime() : 0\r\n          if (!existing || msgTime > existing.lastAt) {\r\n            map.set(otherId, {\r\n              peerId: otherId,\r\n              lastText: m.text || \"\",\r\n              lastAt: msgTime,\r\n              lastSentAtRaw: m.sentAt || null,\r\n            })\r\n          }\r\n        })\r\n\r\n        const peers = Array.from(map.values()).sort((a, b) => b.lastAt - a.lastAt)\r\n\r\n        // Fetch user info for each peer in parallel.\r\n        // Prefer RESTful GET /api/users/:id, fallback to /api/users?operation=get-user&id=...\r\n        const details = await Promise.all(peers.map(async (p) => {\r\n          try {\r\n            // Try RESTful route first\r\n            try {\r\n              const r = await fetch(`/api/users/${encodeURIComponent(p.peerId)}`)\r\n              if (r.ok) {\r\n                const pl = await r.json().catch(() => null)\r\n                const user = pl?.user ?? pl ?? null\r\n                return { ...p, peer: user }\r\n              }\r\n            } catch (e) {\r\n              // ignore and try fallback\r\n            }\r\n\r\n            // Fallback to query-based endpoint\r\n            try {\r\n              const r2 = await fetch(`/api/users?operation=get-user&id=${encodeURIComponent(p.peerId)}`)\r\n              if (r2.ok) {\r\n                const pl2 = await r2.json().catch(() => null)\r\n                return { ...p, peer: pl2?.user || pl2 || null }\r\n              }\r\n            } catch (e) {\r\n              // ignore\r\n            }\r\n\r\n            return { ...p, peer: null }\r\n          } catch (e) {\r\n            return { ...p, peer: null }\r\n          }\r\n        }))\r\n\r\n        setConversations(details)\r\n      } catch (err) {\r\n        setError(err.message || \"Failed to load conversations\")\r\n      } finally {\r\n        setLoading(false)\r\n      }\r\n    }\r\n\r\n    loadConversations()\r\n  }, [currentUserId])\r\n\r\n  const openConversation = (peerId) => {\r\n    if (!peerId) return\r\n    // Prefer route-based chat page\r\n    router.push(`/uis/user-space/chat/${encodeURIComponent(peerId)}`)\r\n  }\r\n\r\n  // client-side filtering by peer pseudo / firstName\r\n  const filteredConversations = conversations.filter((c) => {\r\n    if (!query.trim()) return true\r\n    const peer = c.peer\r\n    const name = peer ? (peer.pseudo || peer.firstName || '') : ''\r\n    return name.toLowerCase().includes(query.trim().toLowerCase())\r\n  })\r\n\r\n  return (\r\n    <Box sx={{ p: 2 }}>\r\n      <Box sx={{ display: 'flex', justifyContent: 'flex-start', alignItems: 'center', mb: 2 }}>\r\n        <Typography variant=\"h5\" sx={{ fontWeight: 700 }}>Conversations</Typography>\r\n      </Box>\r\n\r\n      {/* Search bar */}\r\n      <Box sx={{ mb: 2 }}>\r\n        <TextField\r\n          fullWidth\r\n          placeholder=\"Search conversations by pseudo...\"\r\n          value={query}\r\n          onChange={(e) => setQuery(e.target.value)}\r\n          variant=\"outlined\"\r\n          size=\"small\"\r\n          InputProps={{\r\n            startAdornment: (\r\n              <InputAdornment position=\"start\">\r\n                <SearchIcon />\r\n              </InputAdornment>\r\n            ),\r\n            endAdornment: (\r\n              <InputAdornment position=\"end\">\r\n                {query ? (\r\n                  <IconButton size=\"small\" onClick={() => setQuery(\"\")}><ClearIcon /></IconButton>\r\n                ) : null}\r\n              </InputAdornment>\r\n            )\r\n          }}\r\n        />\r\n      </Box>\r\n\r\n      {loading ? (\r\n        <Box sx={{ display: 'flex', justifyContent: 'center', p: 3 }}>\r\n          <CircularProgress size={28} />\r\n        </Box>\r\n      ) : error ? (\r\n        <Box sx={{ p: 2 }}>\r\n          <Typography color=\"error\">{error}</Typography>\r\n        </Box>\r\n      ) : conversations.length === 0 ? (\r\n        <Paper variant=\"outlined\" sx={{ p: 4, textAlign: 'center' }}>\r\n          <Typography variant=\"h6\" sx={{ mb: 1 }}>No conversations yet</Typography>\r\n          <Typography variant=\"body2\" color=\"text.secondary\">Start a new chat from the All Users screen.</Typography>\r\n        </Paper>\r\n      ) : (\r\n        <List>\r\n          {filteredConversations.map((c) => {\r\n             const peer = c.peer\r\n             const displayName = peer ? (peer.pseudo || peer.firstName || c.peerId) : (c.peerId || \"â€”\")\r\n             const subtitle = c.lastText || \"\"\r\n             const timeText = c.lastSentAtRaw ? new Date(c.lastSentAtRaw).toLocaleString() : \"\"\r\n             const initial = (peer ? (peer.pseudo || peer.firstName || '') : '').charAt(0).toUpperCase() || '?'\r\n\r\n             return (\r\n               <Box key={c.peerId} sx={{ mb: 1 }}>\r\n                 <Paper\r\n                   onClick={() => openConversation(c.peerId)}\r\n                   elevation={0}\r\n                   sx={{\r\n                     display: 'flex',\r\n                     alignItems: 'center',\r\n                     gap: 2,\r\n                     p: 1.25,\r\n                     cursor: 'pointer',\r\n                     transition: 'background-color 150ms',\r\n                     '&:hover': { backgroundColor: 'action.hover' }\r\n                   }}\r\n                 >\r\n                   <ListItemAvatar>\r\n                     <Avatar sx={{ bgcolor: '#1976d2', width: 44, height: 44, fontWeight: 700 }}>{initial}</Avatar>\r\n                   </ListItemAvatar>\r\n\r\n                   <ListItemText\r\n                     primary={\r\n                       <Typography variant=\"subtitle1\" sx={{ fontWeight: 600 }}>\r\n                         {displayName}\r\n                       </Typography>\r\n                     }\r\n                     secondary={\r\n                       <Typography variant=\"body2\" color=\"text.secondary\" noWrap>\r\n                         {subtitle}\r\n                       </Typography>\r\n                     }\r\n                     sx={{ mr: 2 }}\r\n                   />\r\n\r\n                   <Box sx={{ ml: 'auto', textAlign: 'right' }}>\r\n                     <Typography variant=\"caption\" color=\"text.secondary\" sx={{ display: 'block' }}>{timeText}</Typography>\r\n                   </Box>\r\n                 </Paper>\r\n                 <Divider />\r\n               </Box>\r\n             )\r\n           })}\r\n         </List>\r\n       )}\r\n     </Box>\r\n   )\r\n }"],"names":[],"mappings":"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","debugId":null}}]
}