{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/Saas_MongoDB/mongo/app/uis/user-space/maps/page.js"],"sourcesContent":["'use client';\r\n\r\nimport { useEffect, useState } from 'react';\r\nimport dynamic from 'next/dynamic';\r\nimport 'leaflet/dist/leaflet.css';\r\nimport L from 'leaflet';\r\n\r\n// Dynamically import react-leaflet components to avoid SSR issues\r\nconst MapContainer = dynamic(() => import('react-leaflet').then(m => m.MapContainer), { ssr: false });\r\nconst TileLayer = dynamic(() => import('react-leaflet').then(m => m.TileLayer), { ssr: false });\r\nconst Marker = dynamic(() => import('react-leaflet').then(m => m.Marker), { ssr: false });\r\nconst Popup = dynamic(() => import('react-leaflet').then(m => m.Popup), { ssr: false });\r\n\r\n// Fix Leaflet default icon paths for Next.js/public\r\ndelete L.Icon.Default.prototype._getIconUrl;\r\nL.Icon.Default.mergeOptions({\r\n  iconRetinaUrl: '/leaflet/images/marker-icon-2x.png',\r\n  iconUrl: '/leaflet/images/marker-icon.png',\r\n  shadowUrl: '/leaflet/images/marker-shadow.png',\r\n});\r\n\r\nexport default function MapsPage() {\r\n  const [position, setPosition] = useState(null); // { lat, lng }\r\n  const [loading, setLoading] = useState(true);\r\n  const [statusMessage, setStatusMessage] = useState('Requesting location permission...');\r\n\r\n  // Use same pattern as chat to find current user:\r\n  // 1. call server endpoint /api/users?operation=get-current\r\n  // 2. fallback to localStorage 'user' JSON (same as chat)\r\n  async function resolveCurrentUserId() {\r\n    try {\r\n      const res = await fetch('/api/users?operation=get-current');\r\n      if (res.ok) {\r\n        const payload = await res.json();\r\n        const uid = payload?.user?._id || payload?.user?.id || payload?.current?.id || payload?.id || null;\r\n        if (uid) return uid;\r\n      }\r\n    } catch (err) {\r\n      // ignore and try fallback\r\n    }\r\n\r\n    try {\r\n      const raw = typeof window !== 'undefined' ? localStorage.getItem('user') : null;\r\n      if (raw) {\r\n        const parsed = JSON.parse(raw);\r\n        if (parsed?.id) return parsed.id;\r\n      }\r\n    } catch (err) {\r\n      // ignore\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  async function saveLocationForUser(userId, lat, lng) {\r\n    if (!userId) {\r\n      setStatusMessage('Location available locally (not saved to server - no user id found).');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const res = await fetch(`/api/users/${encodeURIComponent(userId)}/location`, {\r\n        method: 'PATCH',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ lat, lng }),\r\n      });\r\n\r\n      if (!res.ok) {\r\n        const body = await res.json().catch(() => null);\r\n        console.warn('Failed to save location', body);\r\n        setStatusMessage('Location shown locally; failed to save to server.');\r\n        return;\r\n      }\r\n\r\n      setStatusMessage('Location saved to server.');\r\n    } catch (err) {\r\n      console.error('saveLocationForUser error', err);\r\n      setStatusMessage('Location shown locally; error saving to server.');\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (!('geolocation' in navigator)) {\r\n      setStatusMessage('Geolocation not supported by your browser.');\r\n      setLoading(false);\r\n      return;\r\n    }\r\n\r\n    setStatusMessage('Requesting permission to access your location...');\r\n    navigator.geolocation.getCurrentPosition(\r\n      async (pos) => {\r\n        const lat = pos.coords.latitude;\r\n        const lng = pos.coords.longitude;\r\n        setPosition({ lat, lng });\r\n        setLoading(false);\r\n        setStatusMessage('Location obtained.');\r\n\r\n        const uid = await resolveCurrentUserId();\r\n        await saveLocationForUser(uid, lat, lng);\r\n      },\r\n      (err) => {\r\n        console.warn('geolocation error', err);\r\n        if (err.code === err.PERMISSION_DENIED) {\r\n          setStatusMessage('Permission denied. Allow location to display the map marker.');\r\n        } else {\r\n          setStatusMessage('Unable to retrieve your location.');\r\n        }\r\n        setLoading(false);\r\n      },\r\n      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }\r\n    );\r\n  }, []);\r\n\r\n  if (loading) {\r\n    return (\r\n      <div style={{ padding: 16 }}>\r\n        <h3>Mini-Map</h3>\r\n        <p>{statusMessage}</p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div style={{ padding: 8 }}>\r\n      <h3>Mini-Map</h3>\r\n      <p>{statusMessage}</p>\r\n\r\n      {!position ? (\r\n        <div>No location available for this user.</div>\r\n      ) : (\r\n        <div style={{ height: '70vh', width: '100%', border: '1px solid #ddd' }}>\r\n          <MapContainer center={[position.lat, position.lng]} zoom={13} style={{ height: '100%', width: '100%' }}>\r\n            <TileLayer\r\n              attribution=\"&copy; OpenStreetMap contributors\"\r\n              url=\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\"\r\n            />\r\n            <Marker position={[position.lat, position.lng]}>\r\n              <Popup>Your current location</Popup>\r\n            </Marker>\r\n          </MapContainer>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}