{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/Saas_MongoDB/mongo/app/uis/user-space/maps/page.js"],"sourcesContent":["'use client';\r\n\r\nimport { useEffect, useState } from 'react';\r\nimport dynamic from 'next/dynamic';\r\nimport 'leaflet/dist/leaflet.css';\r\nimport L from 'leaflet';\r\n\r\n// Dynamically import react-leaflet components to avoid SSR issues\r\nconst MapContainer = dynamic(() => import('react-leaflet').then(m => m.MapContainer), { ssr: false });\r\nconst TileLayer = dynamic(() => import('react-leaflet').then(m => m.TileLayer), { ssr: false });\r\nconst Marker = dynamic(() => import('react-leaflet').then(m => m.Marker), { ssr: false });\r\nconst Popup = dynamic(() => import('react-leaflet').then(m => m.Popup), { ssr: false });\r\n\r\n// Fix Leaflet default icon paths for Next.js/public\r\ndelete L.Icon.Default.prototype._getIconUrl;\r\nL.Icon.Default.mergeOptions({\r\n  iconRetinaUrl: '/leaflet/images/marker-icon-2x.png',\r\n  iconUrl: '/leaflet/images/marker-icon.png',\r\n  shadowUrl: '/leaflet/images/marker-shadow.png',\r\n});\r\n\r\nexport default function MapsPage() {\r\n  const [position, setPosition] = useState(null); // { lat, lng }\r\n  const [loading, setLoading] = useState(true);\r\n  const [statusMessage, setStatusMessage] = useState('Requesting location permission...');\r\n\r\n  // Use same pattern as chat to find current user:\r\n  // 1. call server endpoint /api/users?operation=get-current\r\n  // 2. fallback to localStorage 'user' JSON (same as chat)\r\n  async function resolveCurrentUserId() {\r\n    try {\r\n      const res = await fetch('/api/users?operation=get-current');\r\n      if (res.ok) {\r\n        const payload = await res.json();\r\n        const uid = payload?.user?._id || payload?.user?.id || payload?.current?.id || payload?.id || null;\r\n        if (uid) return uid;\r\n      }\r\n    } catch (err) {\r\n      // ignore and try fallback\r\n    }\r\n\r\n    try {\r\n      const raw = typeof window !== 'undefined' ? localStorage.getItem('user') : null;\r\n      if (raw) {\r\n        const parsed = JSON.parse(raw);\r\n        if (parsed?.id) return parsed.id;\r\n      }\r\n    } catch (err) {\r\n      // ignore\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  async function saveLocationForUser(userId, lat, lng) {\r\n    if (!userId) {\r\n      setStatusMessage('Location available locally (not saved to server - no user id found).');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const res = await fetch(`/api/users/${encodeURIComponent(userId)}/location`, {\r\n        method: 'PATCH',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ lat, lng }),\r\n      });\r\n\r\n      if (!res.ok) {\r\n        const body = await res.json().catch(() => null);\r\n        console.warn('Failed to save location', body);\r\n        setStatusMessage('Location shown locally; failed to save to server.');\r\n        return;\r\n      }\r\n\r\n      setStatusMessage('Location saved to server.');\r\n    } catch (err) {\r\n      console.error('saveLocationForUser error', err);\r\n      setStatusMessage('Location shown locally; error saving to server.');\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (!('geolocation' in navigator)) {\r\n      setStatusMessage('Geolocation not supported by your browser.');\r\n      setLoading(false);\r\n      return;\r\n    }\r\n\r\n    setStatusMessage('Requesting permission to access your location...');\r\n    navigator.geolocation.getCurrentPosition(\r\n      async (pos) => {\r\n        const lat = pos.coords.latitude;\r\n        const lng = pos.coords.longitude;\r\n        setPosition({ lat, lng });\r\n        setLoading(false);\r\n        setStatusMessage('Location obtained.');\r\n\r\n        const uid = await resolveCurrentUserId();\r\n        await saveLocationForUser(uid, lat, lng);\r\n      },\r\n      (err) => {\r\n        console.warn('geolocation error', err);\r\n        if (err.code === err.PERMISSION_DENIED) {\r\n          setStatusMessage('Permission denied. Allow location to display the map marker.');\r\n        } else {\r\n          setStatusMessage('Unable to retrieve your location.');\r\n        }\r\n        setLoading(false);\r\n      },\r\n      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }\r\n    );\r\n  }, []);\r\n\r\n  if (loading) {\r\n    return (\r\n      <div style={{ padding: 16 }}>\r\n        <h3>Mini-Map</h3>\r\n        <p>{statusMessage}</p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div style={{ padding: 8 }}>\r\n      <h3>Mini-Map</h3>\r\n      <p>{statusMessage}</p>\r\n\r\n      {!position ? (\r\n        <div>No location available for this user.</div>\r\n      ) : (\r\n        <div style={{ height: '70vh', width: '100%', border: '1px solid #ddd' }}>\r\n          <MapContainer center={[position.lat, position.lng]} zoom={13} style={{ height: '100%', width: '100%' }}>\r\n            <TileLayer\r\n              attribution=\"&copy; OpenStreetMap contributors\"\r\n              url=\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\"\r\n            />\r\n            <Marker position={[position.lat, position.lng]}>\r\n              <Popup>Your current location</Popup>\r\n            </Marker>\r\n          </MapContainer>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}