{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///D:/Saas_MongoDB/mongo/app/api/models.js"],"sourcesContent":["import mongoose from \"mongoose\";\n/**\n * Use an environment variable for the URI in production.\n * Fallback to the previous hard-coded URI for local dev if not set.\n */\nconst MONGODB_URI = process.env.MONGODB_URI || \"mongodb://localhost:27017/SocialDB\";\n\n/**\n * Global cache for the connection (useful for serverless / dev hot-reload).\n * We attach to global so multiple module reloads reuse the same connection.\n */\nlet cached = global.mongoose;\n\nif (!cached) {\n  cached = global.mongoose = { conn: null, promise: null };\n}\n\nasync function connectToDatabase() {\n  if (cached.conn) {\n    return cached.conn;\n  }\n\n  if (!cached.promise) {\n    // options can be tuned as needed\n    const opts = {\n      useNewUrlParser: true,\n      useUnifiedTopology: true,\n    };\n    cached.promise = mongoose.connect(MONGODB_URI, opts).then((mongooseInstance) => {\n      return mongooseInstance;\n    });\n  }\n\n  cached.conn = await cached.promise;\n  return cached.conn;\n}\n\n/**\n * Define schemas and models.\n * Use existing compiled models if present (mongoose.models).\n */\n\nconst locationSchema = new mongoose.Schema({ lat: Number, lng: Number }, { _id: false });\n\nconst userSchema = new mongoose.Schema({\n  firstName: { type: String, required: true },\n  lastName: { type: String, required: true },\n  gender: { type: String, required: true },\n  country: { type: String, required: true },\n  pseudo: { type: String, required: true },\n  email: { type: String, required: true, unique: true },\n  password: { type: String, required: true },\n  isOnline: { type: Boolean, default: false },\n  isValidated: { type: Boolean, default: false },\n  location: { type: locationSchema, default: null },\n  validationCode: { type: String, default: null },\n  recoveryCode: { type: String, default: null },\n}, { timestamps: true });\n\nconst postSchema = new mongoose.Schema({\n  content: { type: String, required: true },\n  dateTime: { type: Date, required: true, default: Date.now },\n  user: { type: mongoose.Schema.Types.ObjectId, ref: \"User\" },\n}, { timestamps: true });\n\n/**\n * Message schema - stores a single direct message between two users.\n * Fields:\n * - senderId: ObjectId (ref User)\n * - receiverId: ObjectId (ref User)\n * - text: String (optional)\n * - sentAt: Date\n * - attachments: array of files { type, url, filename, size, mimeType }\n */\nconst attachmentSubSchema = new mongoose.Schema({\n  _id: false,\n  type: { type: String }, // 'image' | 'audio' | other\n  url: { type: String, required: true },\n  filename: { type: String },\n  size: { type: Number },\n  mimeType: { type: String },\n}, { _id: false });\n\nconst messageSchema = new mongoose.Schema({\n  senderId: { type: mongoose.Schema.Types.ObjectId, ref: \"User\", required: true },\n  receiverId: { type: mongoose.Schema.Types.ObjectId, ref: \"User\", required: true },\n  text: { type: String, required: false, default: \"\" }, // optional now\n  sentAt: { type: Date, required: true, default: Date.now },\n  attachments: { type: [attachmentSubSchema], default: [] },\n}, { timestamps: true });\n\n/**\n * Friend (friendship) schema - stores friend requests and accepted/refused relationships\n * Fields:\n * - senderId: ObjectId (ref User)  -> the user who initiated the request\n * - receiverId: ObjectId (ref User) -> the user receiving the request\n * - status: String -> 'pending' | 'accepted' | 'refused'\n */\nconst friendSchema = new mongoose.Schema({\n  senderId: { type: mongoose.Schema.Types.ObjectId, ref: \"User\", required: true },\n  receiverId: { type: mongoose.Schema.Types.ObjectId, ref: \"User\", required: true },\n  status: { type: String, enum: [\"pending\", \"accepted\", \"refused\"], default: \"pending\" },\n}, { timestamps: true });\n\n/**\n * Wallet schema - stores a walletId related to a user and its balance\n * Fields:\n * - walletId: String (unique wallet identifier)\n * - userId: ObjectId (ref User)\n * - balance: Number\n */\nconst walletSchema = new mongoose.Schema({\n  walletId: { type: String, required: true, unique: true },\n  userId: { type: mongoose.Schema.Types.ObjectId, ref: \"User\", required: true, unique: true },\n  balance: { type: Number, required: true, default: 0 },\n}, { timestamps: true });\n\n/**\n * Transaction schema - records transfers between wallets\n * Fields:\n * - senderWalletId: String (walletId of sender)\n * - receiverWalletId: String (walletId of receiver)\n * - amount: Number\n * - status: String (optional - pending/completed/failed)\n * - sentAt: Date\n */\nconst transactionSchema = new mongoose.Schema({\n  senderWalletId: { type: String, required: true },\n  receiverWalletId: { type: String, required: true },\n  amount: { type: Number, required: true },\n  status: { type: String, enum: [\"pending\", \"completed\", \"failed\"], default: \"completed\" },\n  sentAt: { type: Date, required: true, default: Date.now },\n}, { timestamps: true });\n\n/**\n * Avoid model overwrite in dev / hot-reload environments\n */\nconst User = mongoose.models.User || mongoose.model(\"User\", userSchema);\nconst Post = mongoose.models.Post || mongoose.model(\"Post\", postSchema);\nconst Message = mongoose.models.Message || mongoose.model(\"Message\", messageSchema);\nconst Friend = mongoose.models.Friend || mongoose.model(\"Friend\", friendSchema);\nconst Wallet = mongoose.models.Wallet || mongoose.model(\"Wallet\", walletSchema);\nconst Transaction = mongoose.models.Transaction || mongoose.model(\"Transaction\", transactionSchema);\n\n/**\n * Ensure connection is established when this module is imported.\n */\nconnectToDatabase().catch((err) => {\n  console.error(\"Failed to connect to MongoDB\", err);\n});\n\nexport { User, Post, Message, Friend, Wallet, Transaction, connectToDatabase };"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 449, "column": 0}, "map": {"version":3,"sources":["file:///D:/Saas_MongoDB/mongo/app/api/users/route.js"],"sourcesContent":["/** Next Imports */\r\nimport { NextResponse } from \"next/server\"\r\n/** Data Models Imports */\r\nimport { User } from \"../models.js\"\r\nimport nodemailer from \"nodemailer\";\r\n\r\nconst CORS_HEADERS = {\r\n  \"Access-Control-Allow-Origin\": \"*\",\r\n  \"Access-Control-Allow-Methods\": \"GET, POST, OPTIONS\",\r\n  \"Access-Control-Allow-Headers\": \"Content-Type, Authorization\",\r\n}\r\n\r\n/** Handle preflight */\r\nexport function OPTIONS() {\r\n  return new NextResponse(null, { status: 204, headers: CORS_HEADERS })\r\n}\r\n\r\n/** Generate verification/recovery code */\r\nfunction generateCode() {\r\n  return Math.floor(100000 + Math.random() * 900000).toString();\r\n}\r\n\r\n/** Helper: create gmail transporter (keeps same credentials as provided) */\r\nfunction createTransporter() {\r\n  return nodemailer.createTransport({\r\n    service: \"gmail\",\r\n    auth: {\r\n      user: \"Fftt7252@gmail.com\",\r\n      pass: \"soae wjwy yvdz iwwc\"\r\n    }\r\n  })\r\n}\r\n\r\n/** GET Method - support read-only operations from browser (e.g. get-all-users, online) */\r\nexport async function GET(request) {\r\n  try {\r\n    const operation = request.nextUrl.searchParams.get(\"operation\")\r\n    const q = request.nextUrl.searchParams.get(\"q\") || \"\"\r\n\r\n    // New: check if a pseudo is available\r\n    if (operation === \"check-pseudo\") {\r\n      const pseudo = (request.nextUrl.searchParams.get(\"pseudo\") || \"\").trim()\r\n      if (!pseudo) {\r\n        return NextResponse.json({ error: \"Missing pseudo\" }, { status: 400, headers: CORS_HEADERS })\r\n      }\r\n      const found = await User.findOne({ pseudo }).lean()\r\n      return NextResponse.json({ available: !Boolean(found) }, { status: 200, headers: CORS_HEADERS })\r\n    }\r\n\r\n    if (operation === \"get-all-users\") {\r\n      // If a query is provided, perform a case-insensitive search on multiple fields.\r\n      if (q && q.trim() !== \"\") {\r\n        // Escape regex special chars to avoid unintended regex behavior\r\n        const escaped = q.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\")\r\n        const re = new RegExp(escaped, \"i\")\r\n\r\n        // Search pseudo, firstName, lastName, email\r\n        const users = await User.find({\r\n          $or: [\r\n            { pseudo: re },\r\n            { firstName: re },\r\n            { lastName: re },\r\n            { email: re },\r\n          ],\r\n        }).limit(50).lean()\r\n\r\n        users.forEach((u) => { if (u.password) delete u.password })\r\n        return NextResponse.json({ users }, { status: 200, headers: CORS_HEADERS })\r\n      }\r\n\r\n      // No query: return all users (you may want to paginate for large collections)\r\n      const users = await User.find().lean()\r\n      users.forEach((u) => { if (u.password) delete u.password })\r\n      return NextResponse.json({ users }, { status: 200, headers: CORS_HEADERS })\r\n    }\r\n\r\n    if (operation === \"online\") {\r\n      const onlineUsers = await User.find({ isOnline: true }).lean()\r\n      onlineUsers.forEach((u) => { if (u.password) delete u.password })\r\n      return NextResponse.json({ users: onlineUsers }, { status: 200, headers: CORS_HEADERS })\r\n    }\r\n\r\n    // Unknown or unsupported GET operation\r\n    return NextResponse.json({ error: \"Unknown or unsupported GET operation\" }, { status: 400, headers: CORS_HEADERS })\r\n  } catch (error) {\r\n    return NextResponse.json({ error: error.message || String(error) }, { status: 500, headers: CORS_HEADERS })\r\n  }\r\n}\r\n\r\n/** POST Method - create, login, update, recover, logout, set-online, etc. */\r\nexport async function POST(request) {\r\n  try {\r\n    const operation = request.nextUrl.searchParams.get(\"operation\")\r\n\r\n    if (operation === \"create\") {\r\n      const data = await request.json()\r\n\r\n      if (!data || !data.email || !data.password) {\r\n        return NextResponse.json(\r\n          { error: \"Missing required fields (email and password).\" },\r\n          { status: 400, headers: CORS_HEADERS }\r\n        )\r\n      }\r\n\r\n      // Normalize email and pseudo for comparison\r\n      const emailNorm = String(data.email).trim().toLowerCase()\r\n      const pseudoNorm = data.pseudo ? String(data.pseudo).trim() : \"\"\r\n\r\n      // Check for existing user by email OR pseudo\r\n      const existing = await User.findOne({ $or: [{ email: emailNorm }, ...(pseudoNorm ? [{ pseudo: pseudoNorm }] : [])] }).lean()\r\n      if (existing) {\r\n        // Prefer a clear message about which field conflicts\r\n        if (existing.email && existing.email.toLowerCase() === emailNorm) {\r\n          return NextResponse.json(\r\n            { error: \"A user with this email already exists.\" },\r\n            { status: 409, headers: CORS_HEADERS }\r\n          )\r\n        }\r\n        if (pseudoNorm && existing.pseudo === pseudoNorm) {\r\n          return NextResponse.json(\r\n            { error: \"Pseudo already taken.\" },\r\n            { status: 409, headers: CORS_HEADERS }\r\n          )\r\n        }\r\n        // Generic conflict fallback\r\n        return NextResponse.json(\r\n          { error: \"User already exists.\" },\r\n          { status: 409, headers: CORS_HEADERS }\r\n        )\r\n      }\r\n\r\n      // Create: include validation code and send verification email\r\n      const code = generateCode()\r\n      const toCreate = {\r\n        ...data,\r\n        email: emailNorm,\r\n        validationCode: code\r\n      }\r\n\r\n      const created = await User.create(toCreate)\r\n      const out = created && created.toObject ? created.toObject() : created\r\n      if (out && out.password) delete out.password\r\n\r\n      // Transport and send verification email\r\n      const transporter = createTransporter()\r\n\r\n      await transporter.sendMail({\r\n        from: '\"Chocolat Social\" <Fftt7252@gmail.com>', // nom + email\r\n        to: data.email,                                 // email de lâ€™utilisateur\r\n        subject: \"ðŸ”’ Verify Your Email for Chocolat Social\",\r\n        html: `\r\n          <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; border: 1px solid #e0e0e0; border-radius: 10px; background-color: #f9f9f9;\">\r\n            <h2 style=\"color: #333;\">Welcome to Chocolat Social!</h2>\r\n            <p>Hi <strong>${data.pseudo || \"\"}</strong>,</p>\r\n            <p>Thank you for registering. Please use the verification code below to activate your account:</p>\r\n            <div style=\"margin: 20px 0; text-align: center;\">\r\n              <span style=\"font-size: 24px; font-weight: bold; color: #4caf50; padding: 10px 20px; border: 2px dashed #4caf50; border-radius: 8px;\">\r\n                ${code}\r\n              </span>\r\n            </div>\r\n            <p>If you did not register on Chocolat Social, please ignore this email.</p>\r\n            <p style=\"font-size: 12px; color: #777;\">Â© 2025 Chocolat Social. All rights reserved.</p>\r\n          </div>\r\n        `\r\n      });\r\n\r\n      return NextResponse.json({ message: \"User created, check your email\" }, { status: 201, headers: CORS_HEADERS })\r\n    }\r\n\r\n    if (operation === \"login\") {\r\n      const data = await request.json()\r\n      if (!data || !data.email || !data.password) {\r\n        return NextResponse.json({ error: \"Missing email or password\" }, { status: 400, headers: CORS_HEADERS })\r\n      }\r\n\r\n      // NOTE: this repo currently uses plaintext passwords; replace with hashed passwords (bcrypt) later.\r\n      const user = await User.findOne({ email: data.email, password: data.password }).lean()\r\n      if (!user) {\r\n        return NextResponse.json({ error: \"Invalid credentials\" }, { status: 401, headers: CORS_HEADERS })\r\n      }\r\n\r\n      if (user.password) delete user.password\r\n      return NextResponse.json({ user }, { status: 200, headers: CORS_HEADERS })\r\n    }\r\n\r\n    /**\r\n     * NEW: set-online operation\r\n     * Accepts JSON body { id } or { userId } OR query params ?id=... or ?userId=...\r\n     * Marks user as online and updates lastActive timestamp.\r\n     */\r\n    if (operation === \"set-online\") {\r\n      // resilient parsing: prefer JSON body but fall back to URL search params\r\n      let data = null\r\n      try {\r\n        data = await request.json().catch(() => null)\r\n      } catch (e) {\r\n        data = null\r\n      }\r\n\r\n      let id = data?.id || data?.userId || null\r\n\r\n      try {\r\n        const url = new URL(request.url)\r\n        id = id || url.searchParams.get('id') || url.searchParams.get('userId') || null\r\n      } catch (e) {\r\n        // ignore URL parsing errors\r\n      }\r\n\r\n      if (!id) {\r\n        return NextResponse.json({ error: \"Missing user id\" }, { status: 400, headers: CORS_HEADERS })\r\n      }\r\n\r\n      const updated = await User.findByIdAndUpdate(\r\n        id,\r\n        { $set: { isOnline: true, lastActive: new Date() } },\r\n        { new: true, runValidators: true, context: 'query' }\r\n      ).lean()\r\n\r\n      if (!updated) {\r\n        return NextResponse.json({ error: \"User not found\" }, { status: 404, headers: CORS_HEADERS })\r\n      }\r\n\r\n      if (updated.password) delete updated.password\r\n      return NextResponse.json({ user: updated }, { status: 200, headers: CORS_HEADERS })\r\n    }\r\n\r\n    if (operation === \"logout\") {\r\n      // Expect body: { id: \"<userObjectId>\" }\r\n      const data = await request.json().catch(() => null)\r\n      const id = data?.id\r\n      if (!id) {\r\n        return NextResponse.json({ error: \"Missing user id\" }, { status: 400, headers: CORS_HEADERS })\r\n      }\r\n\r\n      const updated = await User.findByIdAndUpdate(\r\n        id,\r\n        { isOnline: false },\r\n        { new: true, runValidators: true, context: 'query' }\r\n      ).lean()\r\n\r\n      if (!updated) {\r\n        return NextResponse.json({ error: \"User not found\" }, { status: 404, headers: CORS_HEADERS })\r\n      }\r\n\r\n      if (updated.password) delete updated.password\r\n      return NextResponse.json({ user: updated }, { status: 200, headers: CORS_HEADERS })\r\n    }\r\n\r\n    if (operation === \"update\") {\r\n      return NextResponse.json({ result: null }, { status: 200, headers: CORS_HEADERS })\r\n    }\r\n\r\n    if (operation === \"verify-code\") {\r\n      // make body parsing resilient and normalize email for lookup\r\n      const data = await request.json().catch(() => null)\r\n      const email = data?.email ? String(data.email).trim().toLowerCase() : \"\"\r\n      const code = data?.code ? String(data.code).trim() : \"\"\r\n      if (!email || !code) {\r\n        return NextResponse.json({ error: \"Missing email or code\" }, { status: 400, headers: CORS_HEADERS })\r\n      }\r\n\r\n      const user = await User.findOne({ email, validationCode: code })\r\n      if (!user) {\r\n        return NextResponse.json({ error: \"Invalid code\" }, { status: 400, headers: CORS_HEADERS })\r\n      }\r\n\r\n      user.isValidated = true\r\n      user.validationCode = null\r\n      await user.save()\r\n\r\n      return NextResponse.json({ message: \"Email verified successfully\" }, { status: 200, headers: CORS_HEADERS })\r\n    }\r\n\r\n    if (operation === \"recover\") {\r\n      const data = await request.json()\r\n      const email = data?.email\r\n      if (!email) {\r\n        return NextResponse.json({ error: \"Missing email\" }, { status: 400, headers: CORS_HEADERS })\r\n      }\r\n\r\n      const user = await User.findOne({ email })\r\n      if (!user) {\r\n        return NextResponse.json({ error: \"Email not found\" }, { status: 404, headers: CORS_HEADERS })\r\n      }\r\n\r\n      // GÃ©nÃ©rer code de rÃ©cupÃ©ration\r\n      const code = generateCode()\r\n      user.recoveryCode = code\r\n      await user.save()\r\n\r\n      // Envoi email\r\n      const transporter = createTransporter()\r\n\r\n      await transporter.sendMail({\r\n        from: '\"Chocolat Social\" <Fftt7252@gmail.com>',\r\n        to: user.email,\r\n        subject: \"Password Recovery Code\",\r\n        html: `\r\n          <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; border: 1px solid #e0e0e0; border-radius: 10px; background-color: #f9f9f9;\">\r\n            <h2>Password Recovery</h2>\r\n            <p>Your recovery code is:</p>\r\n            <div style=\"text-align: center; margin: 20px;\">\r\n              <span style=\"font-size: 24px; font-weight: bold; color: #f44336;\">${code}</span>\r\n            </div>\r\n            <p>If you did not request a password reset, ignore this email.</p>\r\n          </div>\r\n        `\r\n      });\r\n\r\n      return NextResponse.json({ message: \"Recovery code sent to your email\" }, { status: 200, headers: CORS_HEADERS })\r\n    }\r\n\r\n    if (operation === \"reset-password\") {\r\n      const data = await request.json()\r\n      const { email, code, newPassword } = data || {}\r\n\r\n      if (!email || !code || !newPassword) {\r\n        return NextResponse.json({ error: \"Missing email, code or newPassword\" }, { status: 400, headers: CORS_HEADERS })\r\n      }\r\n\r\n      const user = await User.findOne({ email, recoveryCode: code })\r\n      if (!user) {\r\n        return NextResponse.json({ error: \"Invalid code or email\" }, { status: 400, headers: CORS_HEADERS })\r\n      }\r\n\r\n      user.password = newPassword\r\n      user.recoveryCode = null\r\n      await user.save()\r\n\r\n      return NextResponse.json({ message: \"Password reset successfully\" }, { status: 200, headers: CORS_HEADERS })\r\n    }\r\n\r\n    // Unrecognized operation for POST\r\n    return NextResponse.json({ error: \"Unknown operation\" }, { status: 400, headers: CORS_HEADERS })\r\n  } catch (error) {\r\n    return NextResponse.json({ error: error.message || String(error) }, { status: 500, headers: CORS_HEADERS })\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}